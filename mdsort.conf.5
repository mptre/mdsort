.Dd $Mdocdate: March 17 2018 $
.Dt MDSORT.CONF 5
.Os
.Sh NAME
.Nm mdsort.conf
.Nd mdsort configuration file
.Sh DESCRIPTION
.Nm
is the configuration file for
.Xr mdsort 1 .
.Pp
Comments can be put anywhere in the file using a hash mark
.Pq Sq #
and extend to the end of the current line.
.Pp
The configuration starts with one or many maildir definitions.
Each maildir is associated with a block of rules.
For each message present in a maildir, each rule is evaluated in sequential
order where the first matching rule is favored.
.Bl -tag -width Ds
.It Xo Ic maildir
.Dq Ar path
.Op Ar options
.Brq \& Ar rule ... \&
.Xc
A maildir rooted in
.Ar path ;
.Xr mdsort 1
iterates over each message present in the
.Pa cur
and
.Pa new
directory.
The
.Ar options
may be any combination of the following:
.Bl -tag -width Ds
.It Ic sync
Call
.Xr fsync 2
after writing a new message.
.El
.It Xo Ic stdin
.Op Ar options
.Brq \& Ar rule ... \&
.Xc
Accepts a message from stdin.
This type of maildir will only be evaluated if
.Xr mdsort 1
is invoked with the stdin option.
Accepts the same
.Ar options
as listed above with
.Ic sync
being implicitly enabled.
.El
.Pp
A rule is defined as follows:
.Bl -tag -width Ds
.It Ic match Ar condition action ...
A rule starts with the
.Ic match
keyword followed by a condition then actions to perform if the condition
evaluates to true.
Each rule spans to the end of the current line but can extended over multiple
lines using a backslash
.Pq Sq \e .
.Pp
A
.Ar pattern
used within a condition is interpreted as an extended regular expression.
Subexpressions in
.Ar pattern
can be used to interpolate arguments to
.Ar action .
Referencing a subexpression is done using back-references on the form
.Sq \e#
where
.Sq #
is a digit.
The digit refers to the nth subexpression of
.Ar pattern
and will be replaced with the matched string.
By default, subexpressions of the first matching
.Ar pattern
is used.
Each
.Ar pattern
optionally accepts one or many of the following
.Ar flags :
.Bl -tag -width Ds -offset indent
.It f
Force usage of subexpressions from the corresponding pattern,
as opposed of using the ones from the first matching pattern.
.It i
Make pattern case insensitive.
.It l
Lowercase the matched string from a subexpression before interpolation.
Mutually exclusive with
.Sq u .
.It u
Uppercase the matched string from a subexpression before interpolation.
Mutually exclusive with
.Sq l .
.El
.Pp
A
.Ar pattern
is by default expected to be enclosed in a pair of
.Sq /
delimiters.
A literal
.Sq /
can be expressed as
.Sq \e/
inside a
.Ar pattern .
However, any character can be used as the delimiter and same escaping principle
also applies.
.Pp
The conditions are as follows and may be negated:
.Bl -tag -width Ds
.It Xo Op Ic \&!
.Op Ic attachment
.Tg body
.Ic body
.Pf / Ar pattern Ns Pf / Op Ar flags
.Xc
Evaluates to true if the message body matches
.Ar pattern .
.Pp
If
.Ic attachment
is present, evalutes to true if the body of an attachment matches
.Ar pattern .
.It Xo Op Ic \&!
.Op Ic attachment
.Tg header
.Ic header Dq Ar name
.Pf / Ar pattern Ns Pf / Op Ar flags
.Xc
.It Xo Op Ic \&!
.Op Ic attachment
.Ic header No { Do Ar name Dc Ar ... No }
.Pf / Ar pattern Ns Pf / Op Ar flags
.Xc
Evaluates to true if the value of any of the headers with
.Ar name
in message matches
.Ar pattern .
Finding the header with
.Ar name
in message is done case insensitive.
.Pp
If
.Ic attachment
is present, evalutes to true if any of the headers with
.Ar name
in an attachment matches
.Ar pattern .
.It Xo Op Ic \&!
.Tg attachment
.Ic attachment
.Xc
Evaluates to true if the message has attachments.
.It Xo Op Ic \&!
.Tg date
.Ic date
.Op Ar field
.Ic \&>
.Ar age scale
.Xc
.It Xo Op Ic \&!
.Ic date
.Op Ar field
.Ic \&<
.Ar age scale
.Xc
Evaluates to true if the message date
.Ar field
is either greater or less than
.Ar age .
The
.Ar field
must be either
.Ic header , access , modified
or
.Ic created
and defaults to
.Ic header
in which the date header in message is used.
The
.Ar age
must be a positive number.
The
.Ar scale
must be either
.Ic seconds , minutes , hours , days , weeks , months
or
.Ic years .
It may be abbreviated in a non-ambiguous way, such as
.Ic second
or
.Ic s .
.It Xo Op Ic \&!
.Tg all
.Ic all
.Xc
Evaluates to true for any message.
.It Xo Op Ic \&!
.Tg new
.Ic new
.Xc
Evaluates to true if the message is not read.
.It Xo Op Ic \&!
.Tg old
.Ic old
.Xc
Evaluates to true if the message is old.
Meaning, a message that has been read but later flagged as not read.
.El
.Pp
Multiple and nested conditions may also be specified:
.Bl -tag -width Ds
.It Ar condition Ic and Ar condition
Evaluates to true if both
.Ar condition
are true.
.It Ar condition Ic or Ar condition
Evaluates to true if any of the
.Ar condition
are true.
.It Xo Op Ic \&!
.Ic \&( Ar condition Ic \&)
.Xc
Evaluates to true if the nested
.Ar condition
is true.
.El
.Pp
Next comes one or many actions:
.Bl -tag -width Ds
.It Ic break
Abort evaluation of the current block of rules.
Especially useful when using nested
.Ic match
blocks, see below.
.Pp
Mutually exclusive with all other actions.
.It Xo Ic exec
.Op Ar options
.Dq Ar command
.Xc
.It Xo Ic exec
.Op Ar options
.No { Do Ar command Dc Ar ... No }
.Xc
Execute
.Ar command ,
which
may contain back-references.
The
.Ar options
may be any combination of the following:
.Bl -tag -width Ds
.It Ic stdin
Pass the matched message on stdin to
.Ar command .
.El
.It Ic discard
Remove the message from the maildir.
.Pp
Mutually exclusive with all other actions.
.It Ic flag Oo Ic \&! Oc Ic new
Flag the message as read or not.
.It Ic label Dq Ar label
.It Ic label No { Do Ar label Dc Ar ... No }
Add
.Ar label
to the X-Label header in message.
The
.Ar label
may contain back-references.
.It Ic move Dq Ar path
Move the message to the maildir located at
.Ar path .
The
.Ar path
may contain back-references.
.Pp
Only one
.Ic move
action can be defined per rule.
.It Ic pass
Continue evaluation of the current block of rules up to the next matching
rule.
.El
.Pp
In addition,
.Ic stdin
also supports the following actions:
.Bl -tag -width Ds
.It Ic reject
Reject the message by causing
.Xr mdsort 1
to exit non-zero.
.Pp
Mutually exclusive with all other actions.
.El
.It Ic match Ar condition No { Ar rule ... No }
The nested block of rules
is only evaluated if
.Ar condition
is true.
.El
.Sh FILES
.Bl -tag -width "~/.mdsort.conf"
.It Pa ~/.mdsort.conf
The default configuration file.
.El
.Sh EXAMPLES
.Bd -literal
maildir "~/Maildir/INBOX" {
	# Move messages from OpenBSD mailing lists into dedicated directories.
	match header { "Cc" "To" } /(bugs|misc|ports|tech)@openbsd.org/i \e
		move "~/Maildir/openbsd-\e1"

	# Label messages with the plus portion of the address.
	match header "To" /user\e+(.+)@example.com/l label "\e1"

	# Archive read messages.
	match ! new move "~/Maildir/Archive"
}

maildir "~/Maildir/Trash" {
	# Delete messages older than 2 weeks.
	match date > 2 weeks discard
}

# Accept messages from stdin and move to the invoking user's inbox.
stdin {
	match all move "~/Maildir/INBOX"
}
.Ed
.Sh SEE ALSO
.Xr mdsort 1 ,
.Xr re_format 7
.Sh AUTHORS
.An Anton Lindqvist Aq Mt anton@basename.se
